

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bipo_fastapi.nodes &#8212; BIPO Demand Forecasting v1.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/bipo_fastapi/nodes';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    <p class="title logo__title">BIPO Demand Forecasting v1.0.0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Project Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Setup</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../inference-deployment-env-setup.html">Deployment Environment Setup - Inference Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../training-deployment-env-setup.html">Deployment Environment Setup - Training Module</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Pipeline</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../kedro-overview.html">Overview of Kedro (v0.18.11)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data-pipeline.html">Data Pipeline</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Training</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../training-pipeline.html">Training Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../experiment-tracking.html">Experiment Tracking</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Serving</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../inference-endpoint.html">Model Serving Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inference-module.html">Inference Module</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Supplementary Guides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQ</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../modules.html">bipo</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../bipo.html">bipo package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../bipo.pipelines.html">bipo.pipelines package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../bipo.pipelines.data_loader.html">bipo.pipelines.data_loader package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../bipo.pipelines.data_merge.html">bipo.pipelines.data_merge package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../bipo.pipelines.data_preprocessing.html">bipo.pipelines.data_preprocessing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../bipo.pipelines.data_split.html">bipo.pipelines.data_split package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../bipo.pipelines.feature_engineering.html">bipo.pipelines.feature_engineering package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../bipo.pipelines.model_evaluation.html">bipo.pipelines.model_evaluation package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../bipo.pipelines.model_specific_preprocessing.html">bipo.pipelines.model_specific_preprocessing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../bipo.pipelines.model_training.html">bipo.pipelines.model_training package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../bipo.pipelines.time_agnostic_feature_engineering.html">bipo.pipelines.time_agnostic_feature_engineering package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../bipo_fastapi.html">bipo_fastapi package</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../tests.html">tests package</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../tests.pipelines.html">tests.pipelines package</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../tests.pipelines.data_loader.html">tests.pipelines.data_loader package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tests.pipelines.data_preprocessing.html">tests.pipelines.data_preprocessing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tests.pipelines.feature_engineering.html">tests.pipelines.feature_engineering package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tests.pipelines.pre_feature_engineering.html">tests.pipelines.pre_feature_engineering package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for bipo_fastapi.nodes</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="c1"># Create a logger for this module</span>
<span class="kn">from</span> <span class="nn">bipo_fastapi.custom_dataset</span> <span class="kn">import</span> <span class="n">CustomCSVDataSet</span>
<span class="kn">from</span> <span class="nn">kedro_datasets.pandas</span> <span class="kn">import</span> <span class="n">CSVDataSet</span>
<span class="kn">from</span> <span class="nn">kedro.io</span> <span class="kn">import</span> <span class="n">DataCatalog</span>
<span class="kn">from</span> <span class="nn">kedro.io</span> <span class="kn">import</span> <span class="n">IncrementalDataset</span>
<span class="kn">from</span> <span class="nn">kedro.config</span> <span class="kn">import</span> <span class="n">ConfigLoader</span>
<span class="kn">from</span> <span class="nn">bipo</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGGER_NAME</span><span class="p">)</span>
<span class="n">conf_loader</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="p">(</span><span class="n">conf_source</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CONF_SOURCE</span><span class="p">)</span>
<span class="n">conf_params</span> <span class="o">=</span> <span class="n">conf_loader</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span>
<span class="n">conf_const</span> <span class="o">=</span> <span class="n">conf_loader</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constants*&quot;</span><span class="p">)</span>
<span class="n">conf_inference</span> <span class="o">=</span> <span class="n">conf_loader</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inference*&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="transform_mkt_input"><a class="viewcode-back" href="../../bipo_fastapi.html#bipo_fastapi.nodes.transform_mkt_input">[docs]</a><span class="k">def</span> <span class="nf">transform_mkt_input</span><span class="p">(</span><span class="n">mkt_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to prepare marketing dataframe for transform_model_input function.</span>
<span class="sd">    This function will rename and convert date related string to datetime format, and convert the campaign name to string</span>

<span class="sd">    Args:</span>
<span class="sd">        mkt_df (pd.DataFrame): Raw inference Marketing dataframe</span>

<span class="sd">    Returns:</span>
<span class="sd">        mkt_df (pd.DataFrame): Processed inference Marketing dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># rename the columns to the raw column input</span>
    <span class="n">new_column_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;campaign_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;campaign_start_date&quot;</span><span class="p">:</span> <span class="s2">&quot;Date Start&quot;</span><span class="p">,</span>
        <span class="s2">&quot;campaign_end_date&quot;</span><span class="p">:</span> <span class="s2">&quot;Date End&quot;</span><span class="p">,</span>
        <span class="s2">&quot;marketing_channels&quot;</span><span class="p">:</span> <span class="s2">&quot;Mode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;total_cost&quot;</span><span class="p">:</span> <span class="s2">&quot;Total Cost&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Rename the columns</span>
    <span class="n">mkt_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">new_column_names</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># set &quot;Date Start&quot; and &quot;Date End&quot; to datetime</span>
    <span class="n">mkt_df</span><span class="p">[</span><span class="s2">&quot;Date End&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">mkt_df</span><span class="p">[</span><span class="s2">&quot;Date End&quot;</span><span class="p">])</span>
    <span class="n">mkt_df</span><span class="p">[</span><span class="s2">&quot;Date Start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">mkt_df</span><span class="p">[</span><span class="s2">&quot;Date Start&quot;</span><span class="p">])</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed transform marketing input&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mkt_df</span></div>


<div class="viewcode-block" id="impute_lag_sales_df"><a class="viewcode-back" href="../../bipo_fastapi.html#bipo_fastapi.nodes.impute_lag_sales_df">[docs]</a><span class="k">def</span> <span class="nf">impute_lag_sales_df</span><span class="p">(</span>
    <span class="n">lag_sales_df</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">outlet_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Imputes lag sales if the given lag sales is less than the required number of days (ie. 14 days from today when the prediction is made). It is assumed that at least, the first 7 days of lag sales is given, as the most recent data might be unavailable. (E.g today is 18 Oct, expected lag sales is 4-17 Oct, and minimum lag sales to be given from 4-10 Oct).</span>
<span class="sd">    - Extends the df by adding empty rows until the last date of the inference period. This ensures there is enough rows to shift forward when generating lag features. </span>
<span class="sd">    - Also renames lag sales column to proxyrevenue. </span>
<span class="sd">    - Assumes the dates are all 1 day increments. (ie. not 4 may, 6 may..)</span>

<span class="sd">    Also, add empty rows to match length of outlet_df. As generation of lag features and tsfresh will shift the values forward to match prediction period.</span>

<span class="sd">    Args:</span>
<span class="sd">        lag_sales_df (pd.DataFrame): lag sales df</span>
<span class="sd">        outlet_df (pd.DataFrame): outlet df</span>

<span class="sd">    Raises:</span>
<span class="sd">        None</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Lag sales df with complete values</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># impute if lag sales is less than lookback period (e.g 14 days)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lag_sales_df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">conf_params</span><span class="p">[</span><span class="s2">&quot;lookback_period&quot;</span><span class="p">]:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lag sales has less than </span><span class="si">{</span><span class="n">conf_params</span><span class="p">[</span><span class="s1">&#39;lookback_period&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">today_date</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="c1"># check if first 7 days of lag sales are given</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">today_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">conf_params</span><span class="p">[</span><span class="s2">&quot;lookback_period&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">lag_sales_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_date</span> <span class="p">:</span> <span class="n">start_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">6</span><span class="p">)]</span>
            <span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="c1"># impute by mapping days with missing value to the same day of the previous week and fill up the lookback period</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Impute missing lag sales values&quot;</span><span class="p">)</span>
            <span class="c1"># fill up df to end of lookback period</span>
            <span class="n">end_date</span> <span class="o">=</span> <span class="n">lag_sales_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">conf_params</span><span class="p">[</span><span class="s2">&quot;lookback_period&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">lag_sales_df</span> <span class="o">=</span> <span class="n">fill_date_range</span><span class="p">(</span><span class="n">lag_sales_df</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
            <span class="n">lag_sales_df</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lag_sales_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span>
            <span class="n">lag_sales_df</span><span class="p">[</span><span class="s2">&quot;lag_sales&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lag_sales_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;day&quot;</span><span class="p">)[</span><span class="s2">&quot;lag_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span>
            <span class="p">)</span>
            <span class="n">lag_sales_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;day&quot;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
            <span class="c1"># rename lag sales to proxyrevenue</span>
            <span class="n">lag_sales_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lag_sales&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">conf_params</span><span class="p">[</span><span class="s1">&#39;columns_to_create_lag_features&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># fill up df to end of prediction period</span>
            <span class="n">lag_sales_df</span> <span class="o">=</span> <span class="n">fill_date_range</span><span class="p">(</span><span class="n">lag_sales_df</span><span class="p">,</span> <span class="n">outlet_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">lag_sales_df</span> <span class="o">=</span> <span class="n">lag_sales_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lag_sales_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Missing values in first 7 days of lag sales data&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lag_sales_df</span>
    <span class="c1"># lag sales is equal to or more than lookback_period</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># add empty rows to match prediction period</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">outlet_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lag_sales_df</span> <span class="o">=</span> <span class="n">fill_date_range</span><span class="p">(</span><span class="n">lag_sales_df</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lag_sales_df</span></div>


<div class="viewcode-block" id="fill_date_range"><a class="viewcode-back" href="../../bipo_fastapi.html#bipo_fastapi.nodes.fill_date_range">[docs]</a><span class="k">def</span> <span class="nf">fill_date_range</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;generate extra empty rows to fill the given dataframe up to the specified date</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): given dataframe</span>
<span class="sd">        end_date (str): end date</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: dataframe that is filled with empty rows to the specified date</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">end_date</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Unable to fill dateframe to given end date as end date is within given dataframe&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">empty_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
            <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">empty_df</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="save_partition_dataset"><a class="viewcode-back" href="../../bipo_fastapi.html#bipo_fastapi.nodes.save_partition_dataset">[docs]</a><span class="k">def</span> <span class="nf">save_partition_dataset</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">partition_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save memorydataset from previous node output as a csv dataset, which is then loaded as a partitioned dataset for downstream nodes which require partitioned dataset as input.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): memorydataset</span>
<span class="sd">        partition_filepath (str): </span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True. This function only returns True to faciliate unit test. The main purpose of this function is to save the memorydataset locally as a csv file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># rename Date column to date</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">conf_const</span><span class="p">[</span><span class="s2">&quot;default_date_col&quot;</span><span class="p">]]</span>
    <span class="c1"># base_filename = partition_filepath.split(&quot;10_model_inference_output/&quot;)[-1]</span>

    <span class="c1"># save as csv file</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">CSVDataSet</span><span class="p">(</span>
        <span class="n">filepath</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partition_filepath</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">conf_const</span><span class="p">[</span><span class="s1">&#39;inference&#39;</span><span class="p">][</span><span class="s1">&#39;lag_sales_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span>
        <span class="n">load_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index_col&quot;</span><span class="p">:</span> <span class="n">conf_const</span><span class="p">[</span><span class="s2">&quot;default_date_col&quot;</span><span class="p">]},</span>
        <span class="n">save_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;index_label&quot;</span><span class="p">:</span> <span class="n">conf_const</span><span class="p">[</span><span class="s2">&quot;default_date_col&quot;</span><span class="p">],</span> <span class="s2">&quot;date_format&quot;</span><span class="p">:</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">DataCatalog</span><span class="p">(</span><span class="n">data_sets</span><span class="o">=</span><span class="p">{</span><span class="n">conf_const</span><span class="p">[</span><span class="s2">&quot;inference&quot;</span><span class="p">][</span><span class="s1">&#39;lag_sales_filename&#39;</span><span class="p">]:</span> <span class="n">output</span><span class="p">})</span>
    <span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">conf_const</span><span class="p">[</span><span class="s2">&quot;inference&quot;</span><span class="p">][</span><span class="s1">&#39;lag_sales_filename&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">)</span>
    <span class="c1"># load as incremental dataset</span>
    <span class="n">partition_df</span> <span class="o">=</span> <span class="n">IncrementalDataset</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">partition_filepath</span><span class="p">,</span>
        <span class="n">dataset</span><span class="o">=</span><span class="n">CustomCSVDataSet</span><span class="p">,</span>
        <span class="n">filename_suffix</span><span class="o">=</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">partition_df</span><span class="o">.</span><span class="n">load</span><span class="p">()</span></div>

<div class="viewcode-block" id="convert_to_string"><a class="viewcode-back" href="../../bipo_fastapi.html#bipo_fastapi.nodes.convert_to_string">[docs]</a><span class="k">def</span> <span class="nf">convert_to_string</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;convert campaign name column to a string datatype. This is unnecessary in the data pipeline as the dataframe has been saved as a csv file and the campaign name is saved as a string. </span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): </span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: dataframe with transformed campaign name column</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="p">[</span><span class="n">conf_params</span><span class="p">[</span><span class="s2">&quot;fe_mkt_column_name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">conf_params</span><span class="p">[</span><span class="s2">&quot;fe_mkt_column_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span> </div>

<div class="viewcode-block" id="process_marketing_df"><a class="viewcode-back" href="../../bipo_fastapi.html#bipo_fastapi.nodes.process_marketing_df">[docs]</a><span class="k">def</span> <span class="nf">process_marketing_df</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">base_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - add Date index name to df generated by create_mkt_campaign_counts_start_end</span>
<span class="sd">    - merge based on common index with the base_df generated by load_and_structure_marketing_data.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): dataframe containing engineered marketing features</span>
<span class="sd">        base_df (pd.DataFrame): base marketing dataframe</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: final processed marketing dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">conf_const</span><span class="p">[</span><span class="s2">&quot;default_date_col&quot;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_df</span><span class="p">)</span> </div>

<div class="viewcode-block" id="merge_generated_features_to_main"><a class="viewcode-back" href="../../bipo_fastapi.html#bipo_fastapi.nodes.merge_generated_features_to_main">[docs]</a><span class="k">def</span> <span class="nf">merge_generated_features_to_main</span><span class="p">(</span><span class="n">generated_features_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">main_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;merge generated_features_df to the main_df for marketing and lag_sales pipeline</span>

<span class="sd">    Args:</span>
<span class="sd">        generated_features_df (pd.DataFrame): generated_features_df</span>
<span class="sd">        main_df (pd.DataFrame): merged df consisting of lag_sales, outlet, marketing </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># lag_sales df </span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generated_features_df</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generated_features_df</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">generated_features_df</span> <span class="o">=</span> <span class="n">generated_features_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">main_df</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">main_df</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">main_df</span> <span class="o">=</span> <span class="n">main_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">main_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">generated_features_df</span><span class="p">)</span></div>



<div class="viewcode-block" id="merge_pipeline_output"><a class="viewcode-back" href="../../bipo_fastapi.html#bipo_fastapi.nodes.merge_pipeline_output">[docs]</a><span class="k">def</span> <span class="nf">merge_pipeline_output</span><span class="p">(</span><span class="n">lag_sales_df</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">marketing_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">outlet_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;merge outputs from lag_sales, marketing, and outlet pipelines. lag_sales  </span>

<span class="sd">    Args:</span>
<span class="sd">        lag_sales_dict (dict): output from lag_sales pipeline</span>
<span class="sd">        marketing_df (pd.DataFrame): output from marketing pipeline</span>
<span class="sd">        outlet_df (pd.DataFrame): output from outlet pipeline</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: merged dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lag_sales_df</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lag_sales_df</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lag_sales_df</span> <span class="o">=</span> <span class="n">lag_sales_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">lag_sales_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">marketing_df</span><span class="p">)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outlet_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged_df</span></div>

<div class="viewcode-block" id="process_final_merged_df"><a class="viewcode-back" href="../../bipo_fastapi.html#bipo_fastapi.nodes.process_final_merged_df">[docs]</a><span class="k">def</span> <span class="nf">process_final_merged_df</span><span class="p">(</span><span class="n">merged_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - drop unnecessary columns</span>
<span class="sd">    - rename column propensity_factor to factor </span>
<span class="sd">    - convert boolean features to numeric </span>

<span class="sd">    Args:</span>
<span class="sd">        merged_df (pd.DataFrame): final merged dataframe after processing and feature engineering</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">conf_inference</span><span class="p">[</span><span class="s2">&quot;columns_to_drop_list&quot;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">conf_inference</span><span class="p">[</span><span class="s2">&quot;inference_columns_rename_map&quot;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># convert bool features to numeric as orderedmodel cannot take in bool features</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">conf_inference</span><span class="p">[</span><span class="s2">&quot;bool_to_numeric_col_list&quot;</span><span class="p">]:</span>
        <span class="n">merged_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span>
                <span class="n">merged_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged_df</span></div>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By AI Singapore
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
       Copyright 2023, AI Singapore.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>