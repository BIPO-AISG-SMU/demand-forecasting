

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bipo.pipelines.feature_engineering.lightweightmmm &#8212; BIPO Demand Forecasting v1.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../../../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/bipo/pipelines/feature_engineering/lightweightmmm';</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
  
    <p class="title logo__title">BIPO Demand Forecasting v1.0.0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">Project Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Setup</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../inference-deployment-env-setup.html">Deployment Environment Setup - Inference Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../training-deployment-env-setup.html">Deployment Environment Setup - Training Module</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Pipeline</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../kedro-overview.html">Overview of Kedro (v0.18.11)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data-pipeline.html">Data Pipeline</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Training</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../training-pipeline.html">Training Pipeline</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../../../experiment-tracking.html">Experiment Tracking</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Serving</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../inference-endpoint.html">Model Serving Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../inference-module.html">Inference Module</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Supplementary Guides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">FAQ</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../modules.html">bipo</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../bipo.html">bipo package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../bipo.pipelines.html">bipo.pipelines package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.data_loader.html">bipo.pipelines.data_loader package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.data_merge.html">bipo.pipelines.data_merge package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.data_preprocessing.html">bipo.pipelines.data_preprocessing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.data_split.html">bipo.pipelines.data_split package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.feature_engineering.html">bipo.pipelines.feature_engineering package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.model_evaluation.html">bipo.pipelines.model_evaluation package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.model_specific_preprocessing.html">bipo.pipelines.model_specific_preprocessing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.model_training.html">bipo.pipelines.model_training package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.time_agnostic_feature_engineering.html">bipo.pipelines.time_agnostic_feature_engineering package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../bipo_fastapi.html">bipo_fastapi package</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../tests.html">tests package</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../tests.pipelines.html">tests.pipelines package</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../tests.pipelines.data_loader.html">tests.pipelines.data_loader package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../tests.pipelines.data_preprocessing.html">tests.pipelines.data_preprocessing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../tests.pipelines.feature_engineering.html">tests.pipelines.feature_engineering package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../tests.pipelines.pre_feature_engineering.html">tests.pipelines.pre_feature_engineering package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for bipo.pipelines.feature_engineering.lightweightmmm</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ndarray</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">kedro.config</span> <span class="kn">import</span> <span class="n">ConfigLoader</span>
<span class="kn">from</span> <span class="nn">kedro.io</span> <span class="kn">import</span> <span class="n">DataCatalog</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">lightweight_mmm</span> <span class="k">as</span> <span class="nn">lw_mmm</span>
<span class="kn">from</span> <span class="nn">lightweight_mmm</span> <span class="kn">import</span> <span class="n">lightweight_mmm</span>
<span class="kn">from</span> <span class="nn">bipo</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGGER_NAME</span><span class="p">)</span>
<span class="c1"># Instantiate config</span>

<span class="n">conf_loader</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CONF_SOURCE</span><span class="p">)</span>
<span class="n">constants</span> <span class="o">=</span> <span class="n">conf_loader</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constants*&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="validate_lags"><a class="viewcode-back" href="../../../../bipo.pipelines.feature_engineering.html#bipo.pipelines.feature_engineering.lightweightmmm.validate_lags">[docs]</a><span class="k">def</span> <span class="nf">validate_lags</span><span class="p">(</span><span class="n">num_lags</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function which validates the input num_lags and attempts to typecast into integer. If negative value is obtained, a default value referencing constants.yml would be used. Same applies if non-numerical value is provided.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_lags (int): _description_</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Validated num_lags with corrected value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">num_lags</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_lags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_lags</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_lags</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="n">default_lightweightmmm_num_lags</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Negative num_lags detected. Overriding with default value: </span><span class="si">{</span><span class="n">num_lag</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">num_lags</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="n">default_lightweightmmm_num_lags</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unable to convert input lightweightMMM lag parameters into integer. Overriding with default value: </span><span class="si">{</span><span class="n">num_lag</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">num_lags</span></div>


<span class="c1"># 1st node</span>
<div class="viewcode-block" id="extract_mmm_params_for_folds"><a class="viewcode-back" href="../../../../bipo.pipelines.feature_engineering.html#bipo.pipelines.feature_engineering.lightweightmmm.extract_mmm_params_for_folds">[docs]</a><span class="k">def</span> <span class="nf">extract_mmm_params_for_folds</span><span class="p">(</span>
    <span class="n">partitioned_outlet_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">params_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function which receives fitted parameters for each training fold using a single outlet in view of common time-index and marketing values across all outlets.</span>

<span class="sd">    These fitted parameters are stored into a Dictionary based on fold from training data folds, which are used to generate additional marketing features.</span>

<span class="sd">    Args:</span>
<span class="sd">        partitioned_outlet_input (Dict[str, pd.DataFrame]): Kedro IncrementalDataSet dictionary containing individual outlet related features dataframe as values with filename as identifier.</span>
<span class="sd">        params_dict (Dict[str, Any]): Dictionary of parameters as referenced from parameters.yml.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Dict]: Dictionary containing fold info as keys as well as fitted LightweightMMM artefacts in a dictionary as value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Extracting LightweightMMM parameters for each fold...&quot;</span><span class="p">)</span>
    <span class="c1"># Read parameters</span>
    <span class="n">target_col</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;fe_target_feature_name&quot;</span><span class="p">]</span>
    <span class="n">mkt_cost_col_list</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;mkt_channel_list&quot;</span><span class="p">]</span>

    <span class="c1"># create empty dictionary to store output artefact name and dictionary artefacts</span>
    <span class="n">mmm_fold_params_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Since marketing features are assumed to be applicable for all outlets, disregarding, we just need to consider the first outlet of each fold in the partition. The file name is of the form e.g &lt;training_fold1_expanding_window_params_....csv&gt;</span>

    <span class="c1"># Get unique folds</span>
    <span class="n">fold_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">partitioned_outlet_input</span><span class="p">]</span>

    <span class="c1"># returns unique fold e.g [&#39;fold1&#39;,&#39;fold2&#39;]</span>
    <span class="n">unique_fold_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fold_list</span><span class="p">))</span>

    <span class="c1"># Required additional constant to avoid ValueError: Normal distribution got invalid loc parameter in lightweightmmm which uses  half-normal distribution with mean zero and standard deviation</span>
    <span class="n">small_value_adjustment</span> <span class="o">=</span> <span class="mf">0.0001</span>

    <span class="k">for</span> <span class="n">current_fold</span> <span class="ow">in</span> <span class="n">unique_fold_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">partition_id</span><span class="p">,</span> <span class="n">partition_load_df</span> <span class="ow">in</span> <span class="n">partitioned_outlet_input</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Skip processing if required columns/features are not found in at least one of the dataframe as all dataframes would contain same columns/features</span>
            <span class="k">if</span> <span class="n">current_fold</span> <span class="ow">in</span> <span class="n">partition_id</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">partition_load_df</span>
                <span class="n">is_valid_mkt_col</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mkt_cost_col_list</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

                <span class="c1"># Immediately end the process since specified columns cannot be found.</span>
                <span class="k">if</span> <span class="n">target_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_valid_mkt_col</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Terminating lightweightMMM fit process as no relevant columns are found.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">mmm_fold_params_dict</span>

                <span class="c1"># Get target and marketing cost columns.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">current_fold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking existence of null with </span><span class="si">{</span><span class="n">partition_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">null_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mkt_cost_col_list</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">null_count</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Imputing with 0s to avoid nulls causing lightweightmmm error as a resort.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">mkt_cost_col_list</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">target_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span>

                <span class="c1"># Value adjustment to avoid 0 value causing issues due to half-norm distribution used by lightweightmmm</span>
                <span class="n">marketing_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mkt_cost_col_list</span><span class="p">]</span> <span class="o">+</span> <span class="n">small_value_adjustment</span>

                <span class="c1"># Sum the values to get total cost</span>
                <span class="n">total_cost_df</span> <span class="o">=</span> <span class="n">marketing_df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;total_cost&quot;</span><span class="p">)</span>

                <span class="c1"># get fitted params in a form of dictionary. Estimate will be</span>
                <span class="n">mmm_fitted_params_dict</span> <span class="o">=</span> <span class="n">get_fitted_parameters</span><span class="p">(</span>
                    <span class="n">marketing_channel_costs</span><span class="o">=</span><span class="n">marketing_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="n">total_marketing_costs</span><span class="o">=</span><span class="n">total_cost_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">target_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="n">channel_columns</span><span class="o">=</span><span class="n">mkt_cost_col_list</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Assign fold info to parametrise learned parameters</span>
                <span class="n">mmm_fold_params_dict</span><span class="p">[</span><span class="n">current_fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmm_fitted_params_dict</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed extraction of fitted params for </span><span class="si">{</span><span class="n">current_fold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Break the loop and go to next fold</span>
                <span class="k">break</span>

            <span class="c1"># Search till first match found</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="k">return</span> <span class="n">mmm_fold_params_dict</span></div>


<span class="c1"># 2nd node</span>
<div class="viewcode-block" id="generate_mmm_features_for_outlets"><a class="viewcode-back" href="../../../../bipo.pipelines.feature_engineering.html#bipo.pipelines.feature_engineering.lightweightmmm.generate_mmm_features_for_outlets">[docs]</a><span class="k">def</span> <span class="nf">generate_mmm_features_for_outlets</span><span class="p">(</span>
    <span class="n">extracted_mmm_params_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
    <span class="n">partitioned_outlet_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
    <span class="n">params_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates lightweightmmm features for each single outlet from each fold. All outlets have the same marketing features, and hence only 1 dataframe will be generated for each fold.</span>

<span class="sd">    Args:</span>
<span class="sd">        extracted_mmm_params_input (Dict[str, Dict])): Dictionary containing fold-based LightweightMMM fitted parameters artefacts</span>
<span class="sd">        partitioned_outlet_input Dict[str, pd.DataFrame]): Kedro IncrementalDataSet dictionary containing individual outlet related features dataframe as values with filename as identifier.</span>
<span class="sd">        params_dict (Dict[str, Any]): Dictionary of parameters as referenced from parameters.yml.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Dict]: Dictionary contain dictionaries of extracted lightweightMMM features by outlet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Read from parameters yml</span>
    <span class="n">mmm_lags</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;lightweightmmm_num_lags&quot;</span><span class="p">]</span>

    <span class="c1"># Convert to boolean state regardless of any entry. So long there is input other than False, or empty value, assume true.</span>
    <span class="n">adstock_normalise</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;lightweightmmm_adstock_normalise&quot;</span><span class="p">])</span>
    <span class="n">optimise_parameters</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;lightweightmmm_optimise_parameters&quot;</span><span class="p">])</span>
    <span class="n">lightweight_params_dict</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;lightweightmmm_params&quot;</span><span class="p">]</span>
    <span class="n">mkt_cost_col_list</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;mkt_channel_list&quot;</span><span class="p">]</span>

    <span class="c1"># Validate specified lags</span>
    <span class="n">mmm_lags</span> <span class="o">=</span> <span class="n">validate_lags</span><span class="p">(</span><span class="n">num_lags</span><span class="o">=</span><span class="n">mmm_lags</span><span class="p">)</span>

    <span class="n">lightweightmmm_features_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">extracted_mmm_params_dict</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;No lightweightMMM artefacts available. Returning empty features dictionary.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">lightweightmmm_features_dict</span>

    <span class="c1"># iterate over fold-based outlet partitions</span>
    <span class="k">for</span> <span class="n">partition_id</span><span class="p">,</span> <span class="n">partition_outlet_df</span> <span class="ow">in</span> <span class="n">partitioned_outlet_input</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Get the current fold and retrieve corresponding fold based parameters</span>
        <span class="n">fold</span> <span class="o">=</span> <span class="n">partition_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># get fitted parameters for specific fold</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start lightweightmmm feature engineering for </span><span class="si">{</span><span class="n">fold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">outlet_df</span> <span class="o">=</span> <span class="n">partition_outlet_df</span>
        <span class="c1"># if optimise_parameters is True, use optimized parameters. Otherwise, use user-defined parameters in config file</span>
        <span class="k">if</span> <span class="n">optimise_parameters</span><span class="p">:</span>
            <span class="n">artefact_dict</span> <span class="o">=</span> <span class="n">extracted_mmm_params_dict</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">artefact_dict</span> <span class="o">=</span> <span class="n">lightweight_params_dict</span>
        <span class="c1"># generate lightweightmmm features</span>
        <span class="n">mmm_features_df</span> <span class="o">=</span> <span class="n">generate_mmm_features</span><span class="p">(</span>
            <span class="n">lightweightmmm_params_artefact</span><span class="o">=</span><span class="n">artefact_dict</span><span class="p">,</span>
            <span class="n">outlet_df</span><span class="o">=</span><span class="n">outlet_df</span><span class="p">,</span>
            <span class="n">mmm_lags</span><span class="o">=</span><span class="n">mmm_lags</span><span class="p">,</span>
            <span class="n">adstock_normalise</span><span class="o">=</span><span class="n">adstock_normalise</span><span class="p">,</span>
            <span class="n">mkt_cost_col_list</span><span class="o">=</span><span class="n">mkt_cost_col_list</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lightweightmmm_features_dict</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">mmm_features_df</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed LightweightMMM feature generation.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lightweightmmm_features_dict</span></div>


<div class="viewcode-block" id="generate_mmm_features"><a class="viewcode-back" href="../../../../bipo.pipelines.feature_engineering.html#bipo.pipelines.feature_engineering.lightweightmmm.generate_mmm_features">[docs]</a><span class="k">def</span> <span class="nf">generate_mmm_features</span><span class="p">(</span>
    <span class="n">lightweightmmm_params_artefact</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">outlet_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">mmm_lags</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">adstock_normalise</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">mkt_cost_col_list</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate lightweightmmm features for a single outlet as called by generate_mmm_features_for_outlets. This includes 2 features - adstock and carryover. This is used for inference (1 outlet), and used as a helper function in run_generate_mmm_features_pipeline during training (multiple outlets).</span>

<span class="sd">    Args:</span>
<span class="sd">        lightweightmmm_params_artefact (Dict): Fitted parameters artefact stored as dictionary using Kedro&#39;s  JSONDatset datatype</span>
<span class="sd">        outlet_df (pd.DataFrame): inference dataframe</span>
<span class="sd">        mmm_lags (int): Lag periods applied for mmm feature generation</span>
<span class="sd">        adstock_normalise (bool): True to normalise adstock values. Otherwise False.</span>
<span class="sd">        mkt_cost_col_list (List): list of marketing daily cost column names</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: dataframe containing generated lightweightmmm features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">marketing_df</span> <span class="o">=</span> <span class="n">outlet_df</span><span class="p">[</span><span class="n">mkt_cost_col_list</span><span class="p">]</span>
    <span class="n">marketing_array</span> <span class="o">=</span> <span class="n">marketing_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">adstock_df</span> <span class="o">=</span> <span class="n">lw_mmm</span><span class="o">.</span><span class="n">media_transforms</span><span class="o">.</span><span class="n">adstock</span><span class="p">(</span>
        <span class="n">marketing_array</span><span class="p">,</span>
        <span class="n">lag_weight</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lightweightmmm_params_artefact</span><span class="p">[</span><span class="s2">&quot;lag_weight&quot;</span><span class="p">]),</span>
        <span class="n">normalise</span><span class="o">=</span><span class="n">adstock_normalise</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">carryover_df</span> <span class="o">=</span> <span class="n">lw_mmm</span><span class="o">.</span><span class="n">media_transforms</span><span class="o">.</span><span class="n">carryover</span><span class="p">(</span>
        <span class="n">marketing_array</span><span class="p">,</span>
        <span class="n">ad_effect_retention_rate</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">lightweightmmm_params_artefact</span><span class="p">[</span><span class="s2">&quot;ad_effect_retention_rate&quot;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">peak_effect_delay</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lightweightmmm_params_artefact</span><span class="p">[</span><span class="s2">&quot;peak_effect_delay&quot;</span><span class="p">]),</span>
        <span class="n">number_lags</span><span class="o">=</span><span class="n">mmm_lags</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># convert adstock and carryover array to df, and rename cols</span>
    <span class="n">adstock_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">adstock_df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;adstock_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mkt_cost_col_list</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">adstock_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">marketing_df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">carryover_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">carryover_df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;carryover_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mkt_cost_col_list</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">carryover_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">marketing_df</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># process adstock and carryover df</span>
    <span class="n">adstock_df</span> <span class="o">=</span> <span class="n">process_mmm_df</span><span class="p">(</span><span class="n">marketing_df</span><span class="p">,</span> <span class="n">adstock_df</span><span class="p">)</span>
    <span class="n">carryover_df</span> <span class="o">=</span> <span class="n">process_mmm_df</span><span class="p">(</span><span class="n">marketing_df</span><span class="p">,</span> <span class="n">carryover_df</span><span class="p">)</span>

    <span class="c1"># merge adstock_df and carryover_df and add to output dictionary</span>
    <span class="n">mmm_features_df</span> <span class="o">=</span> <span class="n">adstock_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">carryover_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mmm_features_df</span></div>


<div class="viewcode-block" id="process_mmm_df"><a class="viewcode-back" href="../../../../bipo.pipelines.feature_engineering.html#bipo.pipelines.feature_engineering.lightweightmmm.process_mmm_df">[docs]</a><span class="k">def</span> <span class="nf">process_mmm_df</span><span class="p">(</span><span class="n">marketing_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">mmm_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function processes mmm dataframes which include adstock and carryover. Previous day&#39;s adstock/carryover values are added to the current day&#39;s daily cost to get the final daily cost which takes into account adstock/carryover effects.</span>

<span class="sd">    Args:</span>
<span class="sd">        marketing_df (pd.DataFrame): Marketing dataframe to be processed.</span>
<span class="sd">        mmm_df (pd.DataFrame): mmm dataframe, which is either adstock/carryover dataframe</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: processed mmm df</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">marketing_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mmm_df</span><span class="p">)</span>
    <span class="c1"># get adstock/carryover and daily cost columns</span>
    <span class="n">mmm_col_list</span> <span class="o">=</span> <span class="n">mmm_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">daily_cost_col_list</span> <span class="o">=</span> <span class="n">marketing_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># shift mmm columns by 1, and fillna with 0 as a result of the shift</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="n">mmm_col_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">mmm_col_list</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="n">mmm_col_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">mmm_col_list</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># create empty dataframe to store newly generated columns</span>
    <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="c1"># iterate over each marketing channel</span>
    <span class="k">for</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mmm_col_list</span><span class="p">,</span> <span class="n">daily_cost_col_list</span><span class="p">):</span>
        <span class="n">result_df</span><span class="p">[</span><span class="n">col1</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">col1</span><span class="p">]</span> <span class="o">+</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">col2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result_df</span></div>


<div class="viewcode-block" id="get_fitted_parameters"><a class="viewcode-back" href="../../../../bipo.pipelines.feature_engineering.html#bipo.pipelines.feature_engineering.lightweightmmm.get_fitted_parameters">[docs]</a><span class="k">def</span> <span class="nf">get_fitted_parameters</span><span class="p">(</span>
    <span class="n">marketing_channel_costs</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">total_marketing_costs</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span>
    <span class="n">channel_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">weekday_seasonality</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">seasonality_frequency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">365</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function which gets fitted parameters based on training fold marketing costs and returns 3 parameters.</span>

<span class="sd">    Lag_weight is extracted from fitted adstock model, while ad_effect_retention_rate and peak_effect_delay are extracted from fitted carryover model.</span>

<span class="sd">    Args:</span>
<span class="sd">        marketing_channel_costs (ndarray): individual marketing channel daily costs</span>
<span class="sd">        total_marketing_costs (ndarray): total cost of each marketing channel</span>
<span class="sd">        channel_columns (list): list of marketing channel columns</span>
<span class="sd">        weekday_seasonality (bool): Whether to estimate a weekday (7) parameter as per LightweightMMM definition.</span>
<span class="sd">        seasonality_frequency (int): Frequency of the time period used. Default is 52 as in 52 weeks per year as per LightweightMMM definition.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, List]: dictionary containing parameter name as keys, and the corresponding parameters as values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># fit adstock model</span>
    <span class="n">mmm_adstock</span> <span class="o">=</span> <span class="n">lightweight_mmm</span><span class="o">.</span><span class="n">LightweightMMM</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;adstock&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fitting adstock model&quot;</span><span class="p">)</span>
    <span class="n">mmm_adstock</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">media</span><span class="o">=</span><span class="n">marketing_channel_costs</span><span class="p">,</span>
        <span class="n">media_prior</span><span class="o">=</span><span class="n">total_marketing_costs</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
        <span class="n">media_names</span><span class="o">=</span><span class="n">channel_columns</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">321</span><span class="p">,</span>
        <span class="n">weekday_seasonality</span><span class="o">=</span><span class="n">weekday_seasonality</span><span class="p">,</span>
        <span class="n">seasonality_frequency</span><span class="o">=</span><span class="n">seasonality_frequency</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># fit carryover model</span>
    <span class="n">mmm_carryover</span> <span class="o">=</span> <span class="n">lightweight_mmm</span><span class="o">.</span><span class="n">LightweightMMM</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;carryover&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fitting carryover model&quot;</span><span class="p">)</span>
    <span class="n">mmm_carryover</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">media</span><span class="o">=</span><span class="n">marketing_channel_costs</span><span class="p">,</span>
        <span class="n">media_prior</span><span class="o">=</span><span class="n">total_marketing_costs</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
        <span class="n">media_names</span><span class="o">=</span><span class="n">channel_columns</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">321</span><span class="p">,</span>
        <span class="n">weekday_seasonality</span><span class="o">=</span><span class="n">weekday_seasonality</span><span class="p">,</span>
        <span class="n">seasonality_frequency</span><span class="o">=</span><span class="n">seasonality_frequency</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># create dictionary to store parameters</span>
    <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># extract parameters from adstock and carryover models</span>
    <span class="n">lag_weight</span> <span class="o">=</span> <span class="n">mmm_adstock</span><span class="o">.</span><span class="n">_mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()[</span><span class="s2">&quot;lag_weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;lag_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lag_weight</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ad_effect_retention_rate</span> <span class="o">=</span> <span class="n">mmm_carryover</span><span class="o">.</span><span class="n">_mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()[</span>
        <span class="s2">&quot;ad_effect_retention_rate&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">peak_effect_delay</span> <span class="o">=</span> <span class="n">mmm_carryover</span><span class="o">.</span><span class="n">_mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()[</span><span class="s2">&quot;peak_effect_delay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;ad_effect_retention_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ad_effect_retention_rate</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;peak_effect_delay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_effect_delay</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">params_dict</span></div>


<div class="viewcode-block" id="merge_mmm_features_with_fold_outlets"><a class="viewcode-back" href="../../../../bipo.pipelines.feature_engineering.html#bipo.pipelines.feature_engineering.lightweightmmm.merge_mmm_features_with_fold_outlets">[docs]</a><span class="k">def</span> <span class="nf">merge_mmm_features_with_fold_outlets</span><span class="p">(</span>
    <span class="n">partitioned_outlet_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
    <span class="n">partitioned_mmm_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function which left merges a fold-based generated LightweightMMM features to each outlet based on common time-index. This is on the assumption that LightweightMMM features are applicable across all-outlets regardless of outlet types.</span>

<span class="sd">    Args:</span>
<span class="sd">        partitioned_outlet_input (Dict[str, pd.DataFrame]): Dataframe partitioned by outlets from Kedro PartitionedDataSet.</span>
<span class="sd">        partitioned_mmm_input (Dict[str, pd.DataFrame]): Generated fold-based LightweightMMM features dataframe partitioned by folds.</span>

<span class="sd">    Raises:</span>
<span class="sd">        None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, pd.DataFrame]: Dictionary containing merged dataframes involving both lightweightMMM features and input outlet dataframe features. Otherwise, returns partitioned_outlet_input with dataframe lazy loading function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">partitioned_mmm_input</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;No lightweightMMM features to merge, skipping merging of such features to outlet dataframes.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">partitioned_outlet_input</span>
    <span class="n">merged_partitioned_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Catch cases when partitioned_mmm_input is empty</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Merging lightweightmmm features with fold outlets...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">partitioned_id</span><span class="p">,</span> <span class="n">partitioned_df</span> <span class="ow">in</span> <span class="n">partitioned_outlet_input</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Retrieve fold information from partitioned_outlet_input</span>
        <span class="n">fold_info</span> <span class="o">=</span> <span class="n">partitioned_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">outlet_fold_df</span> <span class="o">=</span> <span class="n">partitioned_df</span>

        <span class="n">outlet_fold_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">outlet_fold_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Load the corresponding fold in lightweightmmm partitions</span>
        <span class="n">mmm_fold_df</span> <span class="o">=</span> <span class="n">partitioned_mmm_input</span><span class="p">[</span><span class="n">fold_info</span><span class="p">]</span>
        <span class="n">mmm_fold_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">mmm_fold_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">outlet_fold_mmm_df</span> <span class="o">=</span> <span class="n">outlet_fold_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">mmm_fold_df</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_y&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Drop excess columns with _y suffix due to emrge</span>
        <span class="n">col_with_y_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">outlet_fold_mmm_df</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_y&quot;</span><span class="p">)]</span>
        <span class="n">outlet_fold_mmm_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">col_with_y_suffix</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">merged_partitioned_dict</span><span class="p">[</span><span class="n">partitioned_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlet_fold_mmm_df</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed LightweightMMM features merged with folds.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged_partitioned_dict</span></div>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By AI Singapore
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
       Copyright 2023, AI Singapore.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>