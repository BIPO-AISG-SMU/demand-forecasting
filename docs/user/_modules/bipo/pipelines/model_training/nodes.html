

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bipo.pipelines.model_training.nodes &#8212; BIPO Demand Forecasting v1.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../../../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/bipo/pipelines/model_training/nodes';</script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
  
    <p class="title logo__title">BIPO Demand Forecasting v1.0.0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">Project Overview</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Setup</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../inference-deployment-env-setup.html">Deployment Environment Setup - Inference Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../training-deployment-env-setup.html">Deployment Environment Setup - Training Module</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Pipeline</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../kedro-overview.html">Overview of Kedro (v0.18.11)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data-pipeline.html">Data Pipeline</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Training</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../training-pipeline.html">Training Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../experiment-tracking.html">Experiment Tracking</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Serving</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../inference-endpoint.html">Model Serving Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../inference-module.html">Inference Module</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Supplementary Guides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">FAQ</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../modules.html">bipo</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../bipo.html">bipo package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../bipo.pipelines.html">bipo.pipelines package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.data_loader.html">bipo.pipelines.data_loader package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.data_merge.html">bipo.pipelines.data_merge package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.data_preprocessing.html">bipo.pipelines.data_preprocessing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.data_split.html">bipo.pipelines.data_split package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.feature_engineering.html">bipo.pipelines.feature_engineering package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.model_evaluation.html">bipo.pipelines.model_evaluation package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.model_specific_preprocessing.html">bipo.pipelines.model_specific_preprocessing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.model_training.html">bipo.pipelines.model_training package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../bipo.pipelines.time_agnostic_feature_engineering.html">bipo.pipelines.time_agnostic_feature_engineering package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../bipo_fastapi.html">bipo_fastapi package</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../../tests.html">tests package</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../../tests.pipelines.html">tests.pipelines package</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../tests.pipelines.data_loader.html">tests.pipelines.data_loader package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../tests.pipelines.data_preprocessing.html">tests.pipelines.data_preprocessing package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../tests.pipelines.feature_engineering.html">tests.pipelines.feature_engineering package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../tests.pipelines.pre_feature_engineering.html">tests.pipelines.pre_feature_engineering package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for bipo.pipelines.model_training.nodes</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is a boilerplate pipeline &#39;model_training&#39;</span>
<span class="sd">generated using Kedro 0.18.11</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">statsmodels.miscmodels.ordinal_model</span> <span class="kn">import</span> <span class="n">OrderedModel</span>
<span class="kn">from</span> <span class="nn">interpret.glassbox</span> <span class="kn">import</span> <span class="n">ExplainableBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">kedro.config</span> <span class="kn">import</span> <span class="n">ConfigLoader</span>
<span class="kn">from</span> <span class="nn">bipo</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="n">conf_loader</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="p">(</span><span class="n">conf_source</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">CONF_SOURCE</span><span class="p">)</span>
<span class="n">conf_constants</span> <span class="o">=</span> <span class="n">conf_loader</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constants*&quot;</span><span class="p">)</span>
<span class="n">conf_params</span> <span class="o">=</span> <span class="n">conf_loader</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOGGER_NAME</span><span class="p">)</span>


<div class="viewcode-block" id="train_model"><a class="viewcode-back" href="../../../../bipo.pipelines.model_training.html#bipo.pipelines.model_training.nodes.train_model">[docs]</a><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span>
    <span class="n">partitioned_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
    <span class="n">params_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">model_namespace_params_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ExplainableBoostingClassifier</span><span class="p">,</span> <span class="n">OrderedModel</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function that trains a model on a specified data fold defined by parameters.yml from a Kedro IncrementalDataSet contaning various data features identified by suffix &#39;_X&#39; representing predictor features and suffix &#39;_y&#39; representing predicted feature.</span>

<span class="sd">    Args:</span>
<span class="sd">        partitioned_input (Dict[str, pd.DataFrame]): A dictionary with partition ids as keys and dataframe as values.</span>
<span class="sd">        params_dict (Dict[str, Any]): Dictionary referencing parameters.yml.</span>
<span class="sd">        model_namespace_params_dict (Dict[str, Any]): Dictionary referencing values from parameters/model_training.yml</span>

<span class="sd">    Raises:</span>
<span class="sd">        None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[ExplainableBoostingClassifier, OrderedModel]: Either ExplainableBoostingClassifier or OrderedModel: Classes representing fitted model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get parameters from dictionary. Contains filepath to reference as part</span>
    <span class="n">model_params_dict</span> <span class="o">=</span> <span class="n">model_namespace_params_dict</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;model_name&quot;</span><span class="p">])</span>

    <span class="c1"># From parameters.yml</span>
    <span class="n">fold</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;fold&quot;</span><span class="p">])</span>
    <span class="n">split_approach</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;split_approach_source&quot;</span><span class="p">])</span>

    <span class="c1"># Get encoding labels of the target from on binning_dict which would consist the labels used for target feature which is binned.This is based on non-binned feature</span>
    <span class="n">target_feature_name</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;fe_target_feature_name&quot;</span><span class="p">]</span>
    <span class="n">bin_labels_list</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;binning_dict&quot;</span><span class="p">][</span><span class="n">target_feature_name</span><span class="p">]</span>

    <span class="n">target_column_for_modeling</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;target_column_for_modeling&quot;</span><span class="p">]</span>

    <span class="c1"># Extract config for mlflow</span>
    <span class="n">enable_mlflow</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;enable_mlflow&quot;</span><span class="p">]</span>

    <span class="n">X_train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">y_train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Convert string to integer using enumerate</span>
    <span class="n">binned_target_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bin_labels_list</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Defined binning mapping: </span><span class="si">{</span><span class="n">binned_target_mapping</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Construct path using template (based on file name in data/models_specific_preprocessing)</span>
    <span class="k">for</span> <span class="n">partition_id</span><span class="p">,</span> <span class="n">partition_df</span> <span class="ow">in</span> <span class="n">partitioned_input</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">X_train_df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">y_train_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fold</span> <span class="ow">in</span> <span class="n">partition_id</span> <span class="ow">and</span> <span class="n">split_approach</span> <span class="ow">in</span> <span class="n">partition_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">partition_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_X&quot;</span><span class="p">):</span>
                    <span class="n">X_train_df</span> <span class="o">=</span> <span class="n">partition_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">partition_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_y&quot;</span><span class="p">):</span>
                    <span class="n">y_train_df</span> <span class="o">=</span> <span class="n">partition_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="c1"># Convert y values to numeric</span>
                    <span class="n">y_train_df</span> <span class="o">=</span> <span class="n">y_train_df</span><span class="p">[</span><span class="n">target_column_for_modeling</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                        <span class="n">binned_target_mapping</span><span class="p">,</span> <span class="n">na_action</span><span class="o">=</span><span class="kc">None</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Terminate loop when both X and y are not empty</span>
            <span class="k">break</span>

    <span class="c1"># Load X,y data</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Loaded dataframes for training based on fold: </span><span class="si">{</span><span class="n">fold</span><span class="si">}</span><span class="s2"> and split approach </span><span class="si">{</span><span class="n">split_approach</span><span class="si">}</span><span class="s2">, shapes of X: </span><span class="si">{</span><span class="n">X_train_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, y: </span><span class="si">{</span><span class="n">y_train_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Check validity of model name</span>
    <span class="n">valid_model_name_list</span> <span class="o">=</span> <span class="n">conf_constants</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;valid_model_name&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_model_name_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid mode detected and does not belong to either of  </span><span class="si">{</span><span class="n">valid_model_name_list</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Using default model name: </span><span class="si">{</span><span class="n">conf_constants</span><span class="p">[</span><span class="s1">&#39;modeling&#39;</span><span class="p">][</span><span class="s1">&#39;model_name_default&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">conf_constants</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;model_name_default&quot;</span><span class="p">]</span>

    <span class="c1"># Read parameters for instantiating necessary models</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instantiating </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> with necessary parameters&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to retrieve parameters required...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;ebm&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">outer_bags</span> <span class="o">=</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;outer_bags&quot;</span><span class="p">]</span>
            <span class="n">inner_bags</span> <span class="o">=</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;inner_bags&quot;</span><span class="p">]</span>
            <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">]</span>
            <span class="n">interactions</span> <span class="o">=</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;interactions&quot;</span><span class="p">]</span>
            <span class="n">max_bins</span> <span class="o">=</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;max_bins&quot;</span><span class="p">]</span>
            <span class="n">max_leaves</span> <span class="o">=</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;max_leaves&quot;</span><span class="p">]</span>
            <span class="n">min_samples_leaf</span> <span class="o">=</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;min_samples_leaf&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted parameters for ebm:</span><span class="si">{</span><span class="n">model_params_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Unable to reference required parameters for ebm model due to key error. Using default settings...&quot;</span>
            <span class="p">)</span>
            <span class="n">ebm_params_const_dict</span> <span class="o">=</span> <span class="n">conf_constants</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;ebm&quot;</span><span class="p">]</span>
            <span class="c1"># Read off defaults from constants.yml</span>
            <span class="n">outer_bags</span> <span class="o">=</span> <span class="n">ebm_params_const_dict</span><span class="p">[</span><span class="s2">&quot;outer_bags&quot;</span><span class="p">]</span>
            <span class="n">inner_bags</span> <span class="o">=</span> <span class="n">ebm_params_const_dict</span><span class="p">[</span><span class="s2">&quot;inner_bags&quot;</span><span class="p">]</span>
            <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">ebm_params_const_dict</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">]</span>
            <span class="n">interactions</span> <span class="o">=</span> <span class="n">ebm_params_const_dict</span><span class="p">[</span><span class="s2">&quot;interactions&quot;</span><span class="p">]</span>
            <span class="n">max_bins</span> <span class="o">=</span> <span class="n">ebm_params_const_dict</span><span class="p">[</span><span class="s2">&quot;max_bins&quot;</span><span class="p">]</span>
            <span class="n">max_leaves</span> <span class="o">=</span> <span class="n">ebm_params_const_dict</span><span class="p">[</span><span class="s2">&quot;max_leaves&quot;</span><span class="p">]</span>
            <span class="n">min_samples_leaf</span> <span class="o">=</span> <span class="n">ebm_params_const_dict</span><span class="p">[</span><span class="s2">&quot;min_samples_leaf&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default parameters for ebm:</span><span class="si">{</span><span class="n">ebm_params_const_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instantiating EBM&quot;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ExplainableBoostingClassifier</span><span class="p">(</span>
            <span class="n">feature_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">feature_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">max_bins</span><span class="o">=</span><span class="n">max_bins</span><span class="p">,</span>
            <span class="n">outer_bags</span><span class="o">=</span><span class="n">outer_bags</span><span class="p">,</span>
            <span class="n">inner_bags</span><span class="o">=</span><span class="n">inner_bags</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">min_samples_leaf</span><span class="o">=</span><span class="n">min_samples_leaf</span><span class="p">,</span>
            <span class="n">interactions</span><span class="o">=</span><span class="n">interactions</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying normal fit&quot;</span><span class="p">)</span>
        <span class="n">trained_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_df</span><span class="p">,</span> <span class="n">y_train_df</span><span class="p">)</span>

        <span class="c1"># Run MLflow tracking if enabled</span>
        <span class="k">if</span> <span class="n">enable_mlflow</span><span class="p">:</span>
            <span class="n">mlflow_tracking</span><span class="p">(</span><span class="n">params_dict</span><span class="p">,</span> <span class="n">model_params_dict</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed model training using Explanable Boosting Machine.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># For ordered model</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Extract information from params dict</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">distr</span> <span class="o">=</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;distr&quot;</span><span class="p">]</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
            <span class="n">max_iter</span> <span class="o">=</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;max_iter&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted parameters for OrderedModel:</span><span class="si">{</span><span class="n">model_params_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">ordered_model_params_const_dict</span> <span class="o">=</span> <span class="n">conf_constants</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span>
                <span class="s2">&quot;ordered_model&quot;</span>
            <span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Unable to reference required parameters for OrderedModel due to key error. Using default settings...&quot;</span>
            <span class="p">)</span>
            <span class="n">distr</span> <span class="o">=</span> <span class="n">ordered_model_params_const_dict</span><span class="p">[</span><span class="s2">&quot;distr&quot;</span><span class="p">]</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">ordered_model_params_const_dict</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
            <span class="n">max_iter</span> <span class="o">=</span> <span class="n">ordered_model_params_const_dict</span><span class="p">[</span><span class="s2">&quot;max_iter&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using default parameters for ebm:</span><span class="si">{</span><span class="n">ordered_model_params_const_dict</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Instantiate and fit OrderedModel with parameters</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">OrderedModel</span><span class="p">(</span><span class="n">y_train_df</span><span class="p">,</span> <span class="n">X_train_df</span><span class="p">,</span> <span class="n">distr</span><span class="o">=</span><span class="n">distr</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instantiated OrderedModel with parameters </span><span class="si">{</span><span class="n">distr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">trained_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Run MLflow tracking if enabled</span>
        <span class="k">if</span> <span class="n">enable_mlflow</span><span class="p">:</span>
            <span class="n">mlflow_tracking</span><span class="p">(</span><span class="n">params_dict</span><span class="p">,</span> <span class="n">model_params_dict</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed model training using OrderedModel.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trained_model</span></div>


<div class="viewcode-block" id="explain_ebm"><a class="viewcode-back" href="../../../../bipo.pipelines.model_training.html#bipo.pipelines.model_training.nodes.explain_ebm">[docs]</a><span class="k">def</span> <span class="nf">explain_ebm</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">ExplainableBoostingClassifier</span><span class="p">,</span>
    <span class="n">partitioned_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;provides explainability of the ebm model and saves the plotly figure/static image locally. Can either output a png or html file which is configurable by the output_type parameter, where if it is png, a static png file is the output, and if it is html, a html file will be returned. This function is used in the training pipeline.</span>

<span class="sd">    1) global: feature importance for the training dataset. Term importances are the mean absolute contribution (score) each term (feature or interaction) makes to predictions averaged across the training dataset. Contributions are weighted by the number of samples in each bin, and by the sample weights (if any)</span>
<span class="sd">    2) feature: contribution score to predictions made by the model of the specified feature</span>

<span class="sd">    Args:</span>
<span class="sd">        model (ExplainableBoostingClassifier): ebm model weights</span>
<span class="sd">        partitioned_input (Dict[str, pd.DataFrame]):  Kedro IncrementalDataSet Dictionary containing fold-based training dataset containing features and target variables identified with suffixes _X and _y.</span>

<span class="sd">    Returns:</span>
<span class="sd">        plotly.graph_objs: plotly figure. Also saves the plotly figure/static image locally</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># load config</span>
    <span class="n">output_type</span> <span class="o">=</span> <span class="n">conf_params</span><span class="p">[</span><span class="s2">&quot;output_type&quot;</span><span class="p">]</span>
    <span class="n">feature_list</span> <span class="o">=</span> <span class="n">conf_params</span><span class="p">[</span><span class="s2">&quot;feature_to_explain_list&quot;</span><span class="p">]</span>
    <span class="n">output_filepath</span> <span class="o">=</span> <span class="n">conf_constants</span><span class="p">[</span><span class="s2">&quot;modeling&quot;</span><span class="p">][</span><span class="s2">&quot;explainability_filepath&quot;</span><span class="p">]</span>
    <span class="n">fold</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">conf_params</span><span class="p">[</span><span class="s2">&quot;fold&quot;</span><span class="p">])</span>
    <span class="n">split_approach</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">conf_params</span><span class="p">[</span><span class="s2">&quot;split_approach_source&quot;</span><span class="p">])</span>

    <span class="c1"># make directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_filepath</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_filepath</span><span class="p">)</span>
    <span class="c1"># global feature importance</span>
    <span class="n">global_ebm_explanation</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">explain_global</span><span class="p">()</span>
    <span class="n">global_plotly_fig</span> <span class="o">=</span> <span class="n">global_ebm_explanation</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;png&quot;</span><span class="p">:</span>
        <span class="n">global_plotly_fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_filepath</span><span class="si">}</span><span class="s2">/global_feature_importance.png&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>
        <span class="n">global_plotly_fig</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_filepath</span><span class="si">}</span><span class="s2">/global_feature_importance.html&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid value for output_type. Accepts either png or html&quot;</span><span class="p">)</span>

    <span class="c1"># detailed individual feature importance</span>
    <span class="k">for</span> <span class="n">partition_id</span><span class="p">,</span> <span class="n">partition_df</span> <span class="ow">in</span> <span class="n">partitioned_input</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">fold</span> <span class="ow">in</span> <span class="n">partition_id</span> <span class="ow">and</span> <span class="n">split_approach</span> <span class="ow">in</span> <span class="n">partition_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">partition_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_X&quot;</span><span class="p">):</span>
                <span class="n">X_train_df</span> <span class="o">=</span> <span class="n">partition_df</span>
                <span class="k">break</span>
    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_list</span><span class="p">:</span>
        <span class="c1"># get column index of feature</span>
        <span class="n">feature_index</span> <span class="o">=</span> <span class="n">X_train_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
        <span class="n">ebm_explanation</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">explain_global</span><span class="p">()</span>
        <span class="n">plotly_fig</span> <span class="o">=</span> <span class="n">ebm_explanation</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">feature_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;png&quot;</span><span class="p">:</span>
            <span class="n">plotly_fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_filepath</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">_importance.png&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>
            <span class="n">plotly_fig</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_filepath</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">_importance.html&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid value for output_type. Accepts either png or html&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="mlflow_tracking"><a class="viewcode-back" href="../../../../bipo.pipelines.model_training.html#bipo.pipelines.model_training.nodes.mlflow_tracking">[docs]</a><span class="k">def</span> <span class="nf">mlflow_tracking</span><span class="p">(</span>
    <span class="n">params_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">model_params_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Track model training using MLflow and log relevant parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        params_dict (Dict[str, Any]): Dictionary referencing values from parameters.yml</span>
<span class="sd">        model_params_dict (Dict[str, Any]): Dictionary referencing values from parameters/model_training.yml</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True for recognized model; False for unrecognized model name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enabled MLflow tracking&quot;</span><span class="p">)</span>
    <span class="c1"># Generate a unique run_name for MLflow tracking</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;model_name&quot;</span><span class="p">]</span>
    <span class="n">run_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
    <span class="n">run_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">run_timestamp</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Load MLflow setting from the parameters.yml</span>
    <span class="n">is_remote_mlflow</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;is_remote_mlflow&quot;</span><span class="p">]</span>
    <span class="n">tracking_uri</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;tracking_uri&quot;</span><span class="p">]</span>
    <span class="n">experiment_name</span> <span class="o">=</span> <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;experiment_name_prefix&quot;</span><span class="p">]</span>
    <span class="n">experiment_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">experiment_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># If needed, setup environment for the remote tracking server</span>
    <span class="k">if</span> <span class="n">is_remote_mlflow</span><span class="p">:</span>
        <span class="n">setup_remote_mlflow</span><span class="p">(</span><span class="n">tracking_uri</span><span class="p">,</span> <span class="n">experiment_name</span><span class="p">)</span>

    <span class="c1"># Start MLflow tracking</span>
    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s2">&quot;mlflow.runName&quot;</span><span class="p">,</span> <span class="n">run_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;ordered_model&quot;</span><span class="p">:</span>
            <span class="c1"># Log specific parameters for ordered_model</span>
            <span class="n">params_to_log</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;distr&quot;</span><span class="p">:</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;distr&quot;</span><span class="p">],</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">],</span>
                <span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;max_iter&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">params_to_log</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;ebm&quot;</span><span class="p">:</span>
            <span class="c1"># Log specific parameters for ebm</span>
            <span class="n">params_to_log</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;outer_bags&quot;</span><span class="p">:</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;outer_bags&quot;</span><span class="p">],</span>
                <span class="s2">&quot;inner_bags&quot;</span><span class="p">:</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;inner_bags&quot;</span><span class="p">],</span>
                <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">],</span>
                <span class="s2">&quot;interactions&quot;</span><span class="p">:</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;interactions&quot;</span><span class="p">],</span>
                <span class="s2">&quot;max_bins&quot;</span><span class="p">:</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;max_bins&quot;</span><span class="p">],</span>
                <span class="s2">&quot;max_leaves&quot;</span><span class="p">:</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;max_leaves&quot;</span><span class="p">],</span>
                <span class="s2">&quot;min_samples_leaf&quot;</span><span class="p">:</span> <span class="n">model_params_dict</span><span class="p">[</span><span class="s2">&quot;min_samples_leaf&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">params_to_log</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized model_name: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="setup_remote_mlflow"><a class="viewcode-back" href="../../../../bipo.pipelines.model_training.html#bipo.pipelines.model_training.nodes.setup_remote_mlflow">[docs]</a><span class="k">def</span> <span class="nf">setup_remote_mlflow</span><span class="p">(</span><span class="n">remote_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">experiment_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function which set up remote MLflow tracking URI and experiment.</span>

<span class="sd">    Args:</span>
<span class="sd">        remote_uri (str): The desired remote MLflow tracking URI.</span>
<span class="sd">        experiment_name (str): The base name for the experiment.</span>

<span class="sd">    Raises:</span>
<span class="sd">        None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: False if the URI is unavailable for any reason</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enabled remote MLflow tracking server&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_uri</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">is_uri_available</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span><span class="p">:</span>
        <span class="n">is_uri_available</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">is_uri_available</span><span class="p">:</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">remote_uri</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current MLflow tracking uri: </span><span class="si">{</span><span class="n">remote_uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">get_experiment_by_name</span><span class="p">(</span><span class="n">experiment_name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="n">experiment_name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current experiment_name: </span><span class="si">{</span><span class="n">experiment_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Given experiment name &#39;</span><span class="si">{</span><span class="n">experiment_name</span><span class="si">}</span><span class="s2">&#39; doesn&#39;t exist. MLflow will use the &#39;default&#39; experiment name.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Given MLflow tracking URI </span><span class="si">{</span><span class="n">remote_uri</span><span class="si">}</span><span class="s2"> is not reachable. The code will continue to use the &#39;localhost&#39; setting.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By AI Singapore
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023, AI Singapore.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>